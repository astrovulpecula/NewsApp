<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noticias por Temas</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f6f7f9; color:#111; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 4px 16px rgba(0,0,0,.07); }
    .grid { display:grid; gap:16px; }
    .grid2 { grid-template-columns: 1fr 1fr; }
    .btn { display:inline-block; padding:10px 14px; border-radius:12px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .muted { color:#6b7280; }
    .hidden { display:none; }
    a { color:#111; }
    h1,h2,h3 { margin: 0 0 10px; }
    ul { list-style:none; padding:0; margin:0; }
    li + li { margin-top: 8px; }
    .headline { padding:12px; border-radius:12px; border:1px solid #eee; cursor:pointer; }
    .headline:hover { background:#fafafa; }
    .badge { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <header class="grid" style="margin-bottom:16px; align-items:center; grid-template-columns: auto 1fr auto; gap:12px;">
      <div style="width:40px;height:40px;border-radius:12px;background:#111;color:#fff;display:grid;place-items:center;font-weight:700">N</div>
      <div>
        <strong>NewsHub</strong>
        <div class="muted" style="font-size:12px">HTML5 · Vanilla</div>
      </div>
      <div id="connBadge" class="badge">Comprobando…</div>
    </header>

    <!-- Pantalla 1: Home -->
    <section id="view-home" class="grid">
      <div class="card">
        <h1>Noticias por Temas</h1>
        <p class="muted">Selecciona un tema para ver titulares recientes.</p>
      </div>
      <div class="grid grid2">
        <div class="card">
          <h3>Astrofotografía</h3>
          <button class="btn primary" onclick="pickTopic('Astrofotografia')">Ver noticias</button>
        </div>
        <div class="card">
          <h3>Tecnología</h3>
          <button class="btn primary" onclick="pickTopic('Tecnología')">Ver noticias</button>
        </div>
        <div class="card">
          <h3>AI</h3>
          <button class="btn primary" onclick="pickTopic('Inteligencia Artificial')">Ver noticias</button>
        </div>
        <div class="card">
          <h3>Otros temas</h3>
          <div style="display:flex; gap:8px;">
            <input id="customTopic" placeholder="Escribe un tema…" style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd;" />
            <button class="btn" onclick="confirmCustomTopic()">Elegir</button>
          </div>
        </div>
      </div>
      <div class="muted" style="text-align:center; font-size:12px;">Si no hay backend, verás datos de demo. Con backend, verás noticias reales.</div>
    </section>

    <!-- Pantalla 2: Lista -->
    <section id="view-list" class="grid hidden">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 id="list-title" style="margin:0">Tema</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn" onclick="refresh()">Actualizar</button>
          <button class="btn" onclick="goHome()">Inicio</button>
        </div>
      </div>
      <div id="headlines" class="grid"></div>
      <div>
        <button class="btn" onclick="goHome()">← Volver a la pantalla inicial</button>
      </div>
    </section>

    <!-- Pantalla 3: Detalle -->
    <section id="view-detail" class="grid hidden">
      <div class="card">
        <h2 id="detail-title"></h2>
        <div class="muted" id="detail-meta" style="margin-bottom:12px"></div>
        <div id="detail-content" style="line-height:1.6"></div>
        <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
          <a id="detail-link" href="#" target="_blank">Ver fuente original</a>
          <button class="btn" onclick="backToList()">← Volver a titulares</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Ajusta esto SOLO si sirves el HTML en un dominio y el backend en otro.
    // Si TODO está en Vercel (recomendado), deja cadena vacía:
    const BACKEND_URL = ""; // ej. "https://tu-proyecto.vercel.app" si usas GitHub Pages para el HTML

    const state = { topic: "", items: [], active: null, backendOK: false };
    const el = (id) => document.getElementById(id);
    const trimSlash = (s) => s.replace(/\/$/, "");
    const apiUrl = (topic) => `${BACKEND_URL ? trimSlash(BACKEND_URL) : ""}/api/news?topic=${encodeURIComponent(topic)}`;

    function show(view) {
      ["home", "list", "detail"].forEach(v => {
        el(`view-${v}`).classList.toggle("hidden", v !== view);
      });
    }

    function setConnBadge(ok) {
      const b = el("connBadge");
      if (ok) { b.textContent = "Conectado a backend"; b.style.borderColor = "#16a34a"; b.style.color = "#16a34a"; }
      else { b.textContent = "Modo demo"; b.style.borderColor = "#a3a3a3"; b.style.color = "#737373"; }
    }

    async function pingBackend() {
      try {
        const res = await fetch(apiUrl("ping"));
        state.backendOK = res.ok; setConnBadge(true);
      } catch { state.backendOK = false; setConnBadge(false); }
    }

    function goHome() {
      state.topic = ""; state.items = []; state.active = null;
      show("home");
    }

    function pickTopic(t) {
      state.topic = t || "Tema";
      el("list-title").textContent = state.topic;
      show("list");
      loadNews();
    }

    function confirmCustomTopic() {
      const t = (el("customTopic").value || "Tema personalizado").trim();
      pickTopic(t);
    }

    async function loadNews() {
      const list = el("headlines");
      list.innerHTML = `<div class="card">Cargando titulares…</div>`;

      try {
        const res = await fetch(apiUrl(state.topic));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        state.items = (data.articles || []).map((a, idx) => ({
          id: a.id || `${state.topic}-${idx}`,
          title: a.title,
          date: a.publishedAt ? a.publishedAt.slice(0,10) : (a.date || ""),
          sourceName: a.sourceName || (a.source?.name || ""),
          url: a.url,
          content: a.summary || a.content || a.description || "",
        }));
        setConnBadge(true);
      } catch (e) {
        // Fallback demo si no hay backend
        const today = new Date();
        const fmt = (d) => d.toISOString().slice(0,10);
        state.items = Array.from({length:6}).map((_,i)=>{
          const d = new Date(today); d.setDate(d.getDate()-i);
          return { id:`${state.topic}-${i}`, title:`${state.topic}: titular de ejemplo ${i+1}`, date:fmt(d), sourceName:"Demo", url:"#", content:`Cuerpo de ejemplo ${i+1}. Sustituye con el backend.` };
        });
        setConnBadge(false);
      }

      renderList();
    }

    function renderList() {
      const list = el("headlines");
      if (!state.items.length) { list.innerHTML = `<div class="card muted">Sin titulares.</div>`; return; }
      list.innerHTML = "";
      state.items.forEach(item => {
        const li = document.createElement("div");
        li.className = "headline";
        li.innerHTML = `<div><strong>${item.title}</strong></div><div class=\"muted\" style=\"font-size:12px\">Fecha: ${item.date || ""} · Origen: ${item.sourceName || ""}</div>`;
        li.onclick = () => openItem(item);
        list.appendChild(li);
      });
    }

    function openItem(item) {
      state.active = item;
      el("detail-title").textContent = item.title;
      el("detail-meta").textContent = `Fecha: ${item.date || ""} · Origen: ${item.sourceName || ""}`;
      el("detail-content").textContent = item.content || "";
      el("detail-link").href = item.url || "#";
      show("detail");
    }

    function backToList() { show("list"); }
    function refresh() { loadNews(); }

    // Arranque
    pingBackend();
  </script>
</body>
</html>